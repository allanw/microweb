<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<base href="/" />
		<title>Microcosm</title>
		<link rel="shortcut icon" href="/static/img/favico.png" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />

		<link href="/static/themes/1/css/bootstrap.min.css" rel="stylesheet" type="text/css" />

		<!-- Datepicker + Timepicker -->
		<link href="/static/themes/1/css/datepicker.css" rel="stylesheet" type="text/css" />
		<link href="/static/themes/1/css/timepicker.css" rel="stylesheet" type="text/css" />

		<!-- Source Sans Pro -->
		<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:200,400,600,400italic,600italic" rel="stylesheet" type="text/css" />

		<link href="//cdnjs.cloudflare.com/ajax/libs/leaflet/0.5.1/leaflet.min.css" rel="stylesheet" type="text/css" />
		<!--[if lte IE 8]>
			<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/leaflet/0.5.1/leaflet.ie.css" />
		<![endif]-->

		<style>
			.headBand {
				background-image: url('/static/themes/1/background.png');
				background-position: center center;
				margin: 24px 0;
				min-height: 96px;
			}
			.margin-top-half {
				margin-top: 12px;
			}
			.margin-top {
				margin-top: 24px;
			}
			.buffer-right {
				margin-right: 10px;
			}
			.glyphicon {
				font-family: 'Glyphicons Halflings';
				font-style: normal;
				font-weight: normal;
				line-height: 1;
				vertical-align: middle;
			}
		</style>


		<!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
		<!--[if lt IE 9]>
		  <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->
	</head>
<body>
	<div class="headBand">
		<div class="container">
			<header class="row">
				<div class="col-span-16">
					<div class="row">
						<div id="logo" class="col-span-3 margin-top-half">	
							<a href="/"><img src="/static/themes/1/logo.png" alt="Microcosm - Powered by Microcosm" width="320" height="96" /></a>
						</div>
						<div class="col-span-3 pull-right">
							<div class="row margin-top">
								<div class="col-span-4">
									<a href="/profiles/3/edit/"><img src="https://secure.gravatar.com/avatar/18da12b86c5bb5d8af61b3c93cdc8bc3" alt="Avatar for david" title="Edit your profile" /></a>
								</div>
								<div class="col-span-12">
									<a href="/profiles/3/" id="profile_name">david</a><br />
									<a href="/logout/">Log out</a>
								</div>
							</div>
						</div>
					</div>
				</div>
			</header>
		</div>
	</div>

	<div class="container">
		

		<div class="row">
			<section id="content" class="col-span-12">
			<!-- START :: CONTENT -->



<div class="row">
	<div class="col-span-16">
		<h4>Title</h4>
		<p><input id="id_title" type="text" name="title" maxlength="150"></p>
	</div>
</div>

<div class="row">
	<div class="col-span-8">
		<h4>Where</h4>
		<div id="control_where" class="input-group">
			<input id="id_where" type="text" name="where" class="input-with-feedback" maxlength="150" />
			<span class="input-group-btn">
				<button class="btn btn-info" type="button" id="locate">Locate</button>
			</span>
		</div>
	</div>
	<div id="map" class="col-span-8 pull-right" style="height:366px"></div>

	<div class="col-span-8">
		<h4>From</h4>
		<div id="control_from_date" class="control-group">
			<div class="controls col-span-8" style="padding-left:0px">
				<input id="id_from_date" name="from_date" type="text" class="input-with-feedback" value="2013-05-16" />
			</div>
			<div class="input-group col-span-8 bootstrap-timepicker">
				<input id="id_from_time" type="text" />
			</div>
		</div>
	</div>

	<div class="col-span-8">
		<h4>To</h4>
		<div id="control_to_date" class="control-group">
			<div class="controls col-span-8" style="padding-left:0px">
				<input id="id_to_date" name="to_date" type="text" class="input-with-feedback" value="2013-05-16" />
			</div>
			<div class="input-group col-span-8 bootstrap-timepicker">
				<input id="id_to_time" type="text" />
			</div>
		</div>
	</div>

	<div class="col-span-8">
		<h4>Attendee Limit (empty for unlimited)</h4>
		<p><input id="id_rsvp_limit" type="text" name="rsvp_limit" maxlength="150" /></p>
	</div>
</div>

<div><input class="btn btn-primary" type="submit" value="Save Event"></div>



			<!-- END :: CONTENT -->
			</section>

			<section id="sidebar" class="col-offset-1 col-span-3">
				<p><a class="btn btn-primary col-span-16" id="create_microcosm" href="/microcosms/create/">Placeholder</a></p>
			</section>
		</div>

		<footer class="row">
			<div class="col-offset-13 col-span-3">
				<small>Powered by <a href="http://microco.sm/" title="Microcosm is powered by Microcosm">Microcosm</a></small>
			</div>
		</footer>

	</div>

	<!-- jQuery and Bootstrap -->
	<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/jqueryui/1.10.2/jquery-ui.min.js"></script>
	<script src="/static/js/bootstrap.min.js"></script>

	<!-- Leaflet -->
	<script src="//cdnjs.cloudflare.com/ajax/libs/leaflet/0.5.1/leaflet.min.js"></script>

	<script type="text/javascript">
		/////////
		// MAP //
		/////////

		var map = L.map('map')
			.setMaxBounds([[-90,-180],[90,180]]); // Restrict map to valid lat:lng pairs

		L.tileLayer(
			'https://d1qte70nkdppk5.cloudfront.net/d6f1a0c60e9746faa7cbfaec4b92dff3/997/256/{z}/{x}/{y}.png',
			{
				attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>',
				minZoom: 0, // Zoom to world
				maxZoom: 18 // Zoom to finest detail
			}
		).addTo(map);

		var marker;
		function dropMarker(latLng) {
			if (marker) {
				map.removeLayer(marker);
			}

			marker = L.marker(latLng);
			map.addLayer(marker);
			saveLocationState(latLng);
		}

		map.on('click', function(e) {
			dropMarker(e.latlng);
		});

		map.on('moveend', function(e) {
			if (marker) {
				latLng = marker.getLatLng()
				saveLocationState(latLng);
			}
		});

		$('#locate').bind('click', function() {
			var place = $.trim($('#id_where').val());
			if (place == '') {return;}

			// TODO: Put a real access_token in this request or proxy via Django
			var geoCodeUrl = 'https://dev1.microco.sm/api/v1/geocode?access_token=user&q=' + place;
			$.getJSON(geoCodeUrl, function(data) {
				if (!data.found) {
					$('#control_where').addClass('has-error');
					$('#locate').removeClass('btn-info').addClass('btn-danger');
					return;
				}

				var p = data.features[0];
				map.fitBounds(p.bounds);
				dropMarker(new L.LatLng(p.centroid.coordinates[0], p.centroid.coordinates[1]));
			});
		});

		$('#id_where').bind('change', function() {
			if (marker && $('#id_where').val().trim() != '') {
				// Dropping a pin without a label
				$('#control_where').removeClass('has-error');
				$('#locate').removeClass('btn-danger').addClass('btn-info');
			}
		});

		function saveLocationState(latLng) {
			// If not the create/edit page, this should just return and do nothing
			$('#control_where').removeClass('has-error');
			$('#locate').removeClass('btn-danger').addClass('btn-info');

			if (marker && $('#id_where').val().trim() == '') {
				// Dropping a pin without a label
				$('#control_where').addClass('has-error');
				$('#locate').removeClass('btn-info').addClass('btn-danger');
			}

			var b = map.getBounds();
			var sw = b.getSouthWest();
			var ne = b.getNorthEast();
			
			// Save these things
			var lat = latLng.lat;
			var lng = latLng.lng;
			var bounds = "[[" + sw.lat + "," + sw.lng + "],[" + ne.lat + "," + ne.lng + "]]";

			console.log(bounds);
		}

		function restoreLocationState(lat, lng, bounds) {
			map.fitBounds(bounds);
			dropMarker(new L.LatLng(lat, lng));
		}

		// When loading a page and needing to default the map to a specific set of values.
		restoreLocationState(
			51.49852796116709,
			-0.11321067810058594,
			[[51.47860327187397,-0.16805648803710938],[51.5177162373547,-0.0926971435546875]]
		);

		// When loading a page with no location information
		map.fitBounds([[51.47860327187397,-0.16805648803710938],[51.5177162373547,-0.0926971435546875]]) // Default to London, UK
	</script>

	<!-- Datepicker https://github.com/ianserlin/bootstrap-datepicker/tree/3.x -->
	<script src="/static/js/bootstrap-datepicker.js"></script>

	<!-- Timepicker https://github.com/ianserlin/bootstrap-timepicker -->
	<script src="/static/js/bootstrap-timepicker.js"></script>

	<script type="text/javascript">
		//////////
		// DATE //
		//////////

		var startDate = false;
		var endDate = false;

		// Very basic test of dates between 2010-01-01 and 2059-12-31
		var dateReg = /^20[1-5][0-9]-(0[1-9]|1[0-2])-([0][1-9]|[1-2][0-9]|3[0-1])$/

		// Initialisation
		if ($('#id_from_date').val().trim() != "") {
			setStartDate(getDateFromIsoString($('#id_from_date').val()));
		}

		if ($('#id_to_date').val().trim() != "") {
			setEndDate(getDateFromIsoString($('#id_to_date').val()));
		}

		function getDateFromIsoString(d) {
			if (d.match(dateReg)) {
				var ds = d.split("-");
				return new Date(ds[0],ds[1]-1,ds[2]);
			} else {
				return false;
			}
		}

		function setStartDate(d) {
			if (!d) {
				$('#id_from_date').val('')
				startDate = false;
				return;
			}
			startDate = d;
		}

		function setEndDate(d) {
			if (!d) {
				$('#id_to_date').val('')
				endDate = false;
				return;
			}
			endDate = d;
		}

		$('#id_from_date')
			.datepicker({format: 'yyyy-mm-dd'})
			.on('changeDate', function(ev){
				if (endDate && ev.date.valueOf() > endDate.valueOf()){
					setStartDate(new Date(ev.date));
					$('#id_to_date').val($('#id_from_date').val());
				} else {
					$('#control_from_date').removeClass('has-error');
					$('#control_to_date').removeClass('has-error');
					setStartDate(new Date(ev.date));
				}
				$('#id_to_date').datepicker('setStartDate', $('#id_from_date').val());
				$('#id_from_date').datepicker('hide');
			});

		$('#id_to_date')
			.datepicker({format: 'yyyy-mm-dd'})
			.on('changeDate', function(ev){
				if (startDate && ev.date.valueOf() < startDate.valueOf()){
					$('#control_from_date').addClass('has-error');
					$('#control_to_date').addClass('has-error');
					setEndDate(false);
				} else {
					$('#control_from_date').removeClass('has-error');
					$('#control_to_date').removeClass('has-error');
					setEndDate(new Date(ev.date));
				}
				$('#id_to_date').datepicker('hide');
			});

		$('#id_from_date').bind('change', function() {
			var d = $(this).val()
			if (d.trim() == '' || d.match(dateReg)) {
				$('#control_from_date').removeClass('has-error');
			} else {
				$('#control_from_date').addClass('has-error');
			}
		});

		$('#id_to_date').bind('change', function() {
			var d = $(this).val()
			if (d.trim() == '' || d.match(dateReg)) {
				$('#control_to_date').removeClass('has-error');
			} else {
				$('#control_to_date').addClass('has-error');
			}
		});

		if (startDate) {
			// The form has a start date, so we can default the end date picker to not precede it
			$('#id_to_date').datepicker('setStartDate', $('#id_from_date').val());
		} else {
			// Blank form, we can default date pickers to only pick future dates
			var now = new Date()
			var dd = now.getDate();
			var mm = now.getMonth() + 1;
			var today = '' + now.getFullYear() + '-' + (mm <= 9 ? '0' + mm : mm) + '-' + (dd <= 9 ? '0' + dd : dd);
			$('#id_from_date').datepicker('setStartDate', today);
			$('#id_to_date').datepicker('setStartDate', today);
		}

		//////////
		// TIME //
		//////////

		// Initialisation
		var fromTime = ($('#id_from_time').val().trim() != "") ? $('#id_from_time').val() : 'current';
		var toTime = ($('#id_to_time').val().trim() != "") ? $('#id_to_time').val() : 'current';

		$('#id_from_time')
			.timepicker({"disableFocus": true, "defaultTime": fromTime})
			.on('focus', function() {
				$('#id_from_time').timepicker('showWidget');
			});

		$('#id_to_time')
			.timepicker({"disableFocus": true, "defaultTime": fromTime})
			.on('focus', function() {
				$('#id_to_time').timepicker('showWidget');
			});

		function setTime(d, ts) {
			if (!d) {d = new Date()}
			var time = ts.match(/(\d\d):(\d\d)\s(P?)/);
			d.setHours( parseInt(time[1]) + ( ( parseInt(time[1]) < 12 && time[3] ) ? 12 : 0) );
			d.setMinutes( parseInt(time[2]) || 0 );
		}

		// Not all browsers know how to do toISOString()
		if (!Date.prototype.toISOString) {
			Date.prototype.toISOString = function() {
				function pad(n) { return n < 10 ? '0' + n : n }
				return this.getUTCFullYear() + '-'
					+ pad(this.getUTCMonth() + 1) + '-'
					+ pad(this.getUTCDate()) + 'T'
					+ pad(this.getUTCHours()) + ':'
					+ pad(this.getUTCMinutes()) + ':'
					+ pad(this.getUTCSeconds()) + 'Z';
			};
		}

		function validateDateTimes() {
			var startTime = $('#id_from_time').val().trim();
			var endTime = $('#id_to_time').val().trim();
			if (!startDate || !endDate || !startTime || !endTime) {
				console.log('one of the inputs is false');
				return false;
			}

			var startDateTime = startDate;
			setTime(startDateTime, startTime);

			var endDateTime = endDate;
			setTime(endDateTime, endTime);

			if (endDateTime.valueOf() < startDateTime.valueOf()) {
				console.log('endDateTime before startDateTime');
				return false
			}

			// We need the start date and time in ISO8601
			console.log(startDateTime.toISOString());

			// And we need duration in minutes
			var duration = (endDateTime.valueOf() / 60000) - (startDateTime.valueOf() / 60000);
			if (!duration) {duration = 60;}
			console.log(duration);
		}
	</script>

</body>
</html>