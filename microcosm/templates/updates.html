{% extends 'base.html' %}

{% block title %}Updates{% if pagination and pagination.page > 1 %} (page {{ pagination.page }}){% endif %} | {{ site.title }}{% endblock title %}

{% block content %}

<div class="content-header padded">
	<div class="row">
		<div class="col-sm-8">
			{% include 'breadcrumbs.html' %}
		</div>
		<div class="col-sm-4">
			{% include 'pagination.html' %}
		</div>
	</div>
	<h1>Updates</h1>
</div>

<div class="content-body">

	<div class="list-updates">
		{% if user %}

			{% if not content.updates.items %}

			<p>No updates yet. When your username is mentioned or a new comment is posted on an item you're watching, it'll show here.</p>

			{% else %} {# else has content.updates.items #}

			<ul class="list-collection bordered padded">

				{% for update in content.updates.items %}
					<li class="list-collection-row">
						<div class="row">

							<div class="col-sm-10">

								<div class="list-collection-row-icon">
								{% if update.parent_item_type %}
									{% if update.parent_item_type == "conversation" %}
										<span class="sprite sprite-speech-bubble"></span>
									{% elif update.parent_item_type == "event" %}
										<span class="sprite sprite-calendar"></span>
									{% endif %}
								{% else %}
									{% if update.item_type == "conversation" %}
										<span class="sprite sprite-speech-bubble"></span>
									{% elif update.item_type == "event" %}
										<span class="sprite sprite-calendar"></span>
									{% endif %}
								{% endif %}
								</div> <!--/list-collection-row-icon -->

								<div class="list-collection-row-offset">

									<div class="row-title-wrapper">
										{# new comment #}
										{% if update.update_type == "new_comment" %}


											<h3 class="row-title">
												<a href="{{ update.parent_link }}/newest/">
												{{ update.parent_item.title }}
												</a>
											</h3>

											{% if update.meta.flags.unread %}
											<span class="label label-warning">NEW</span>
											{% endif %}

										{# reply to comment #}
										{% elif update.update_type == "reply_to_comment" %}

											<h3 class="row-title">
												<a href="{{ update.profile_link }}">
													@{{ update.item.meta.created_by.profile_name }}
												</a>
											</h3> replied to your comment on <a href="{{ update.parent_link }}">{{ update.parent_item.title }}</a>

											<div class="row-meta">

												<div class="row-meta-excerpt">
													<a href="{% url 'single-profile' update.item.meta.created_by.id %}">
														<img src="{% if 'gravatar' in update.item.meta.created_by.avatar %}{{update.item.meta.created_by.avatar}}{% elif 'files' in update.item.meta.created_by.avatar %}https://{{site.subdomain_key}}.microco.sm{{update.item.meta.created_by.avatar}}{% else %}/static/img/avatar.gif{% endif %}" alt="Avatar for {{update.item.meta.created_by.profile_name }}" align="left" class="img-badge"/>
													</a>
													<div class="row-meta-excerpt-text">
														{{ update.item.html | safe }}
													</div>
												</div>

											</div>

										{# mentioned #}
										{% elif update.update_type == "mentioned" %}

											<h3 class="row-title">
												<a href="{{ update.profile_link }}">
													@{{ update.item.meta.created_by.profile_name }}
												</a>
											</h3>
											mentioned you in
											<a href="{{ update.parent_link }}">{{ update.parent_item.title }}</a>

											<div class="row-meta">

												<div class="row-meta-excerpt">
													<a href="{% url 'single-profile' update.item.meta.created_by.id %}">
														<img src="{% if 'gravatar' in update.item.meta.created_by.avatar %}{{update.item.meta.created_by.avatar}}{% elif 'files' in update.item.meta.created_by.avatar %}https://{{site.subdomain_key}}.microco.sm{{update.item.meta.created_by.avatar}}{% else %}/static/img/avatar.gif{% endif %}" alt="Avatar for {{update.item.meta.created_by.profile_name }}" align="left" class="img-badge"/>
													</a>
													<div class="row-meta-excerpt-text">
														{{ update.item.html | safe }}
													</div>
												</div>

											</div>

										{# new comment in huddle #}
										{% elif update.update_type == "new_comment_in_huddle" %}

											<a href="{{ update.item_link }}">
												<h3 class="row-title">
													{{ update.item.title|safe }}
												</h3>
											</a>
											{% if update.meta.flags.unread %}
											<span class="label label-warning">NEW</span>
											{% endif %}

										{# new attendee #}
										{% elif update.update_type == "new_attendee" %}

											<h3 class="row-title">
												<a href="{{ update.item_link }}/newest/">
													{{ update.item.title|safe }}
												</a>
											</h3>

										{# new vote #}
										{% elif update.update_type == "new_vote" %}

											<a href="{{ update.item_link }}/newest/">
												<h3 class="row-title">{{ update.item.title|safe }}</h3>
											</a>

										{# new event reminder #}
										{% elif update.update_type == "event_reminder" %}

											<a href="{{ update.item_link }}">
												<h3 class="row-title">
													{{ update.item.title|safe }}
												</h3>
											</a>
											{% if update.item_type == "comment" %}
													{{ update.item.html | safe }}
											{% endif %}

										{# new item #}
										{% elif update.update_type == "new_item" %}
											<h3 class="row-title">
												<a href="{{ update.item_link }}">
													{{ update.item.title|safe }}
												</a>
											</h3> was started in
											<a href="{{ update.parent_link }}">
												{{ update.parent_text }}
											</a>
										{% endif %}
									</div> <!-- /row-title-wrapper-->

									<div class="row-meta">

										<span class="sprite sprite-arrow-right"></span>

										<a href="{{ update.parent_link }}">
											view
											{% if update.parent_item_type == "conversation" %}
												conversation
											{% elif update.parent_item_type == "event" %}
												event
											{% elif update.parent_item_type == "poll" %}
												poll
											{% elif update.item_type == "conversation" %}
												conversation
											{% elif update.item_type == "event" %}
												event
											{% elif update.item_type == "poll" %}
												poll
											{% endif %}
										</a>

										{% if update.item_type == "event" %}
												{% if update.item.rsvp_limit %}
												<div class="row-meta-progress">
													<div class="progress">
														<div class="progress-bar"
																 role="progressbar"
																 aria-valuenow="{{update.item.rsvp_percentage}}"
																 aria-valuemin="0"
																 aria-valuemax="100"
																 style="width: {{update.item.rsvp_percentage}}%;">
															<span class="sr-only">{{update.item.rsvp_percentage}}% Complete</span>
														</div>
													</div>
													<strong>
														{{ update.item.rsvp_attend|default:"0" }}/{{ update.item.rsvp_limit }}
													</strong>
												</div>
											{% endif %}
										{% endif %}
										&bull;

										<div class="inline-subscribe">
											<div class="btn-switch on active"
												{% if update.parent_item_type %}
													 data-content-id="{{ update.parent_item.id }}"
													 data-content-type="{{ update.parent_item_type }}"
												{% else %}
													 data-content-id="{{ update.item.id }}"
													 data-content-type="{{ update.item_type }}"
												{% endif %}
											>
												<div class="btn-switch-state loading">
													<img src="/static/img/preloader.gif" />
												</div>
												<div class="btn-switch-state off">
													<span class="sprite sprite-ok-small"></span>
														removed from updates (<a class="btn-switch-on" href="javascript:void 0">undo?</a>)
												</div>
												<div class="btn-switch-state on">
													<a class="btn-switch-off" href="javascript:void 0">
														unsubcribe
													</a>
												</div>
											</div>
										</div>

									</div> <!-- /row-meta -->

								</div> <!-- /list-row-collection-offset -->
							</div>

							<div class="col-sm-2">
								<div class="row-timesince">
									<time datetime="{{ update.meta.created|date:"c" }}">{{ update.meta.created|timesince }}</time>
								</div>
							</div>

						</div> <!-- /row -->
					<li>
				{% endfor %}
			</ul>

			{% endif %} {# endif content.updates.items #}

		{% else %} {# else not user #}

		Please login to recieve updates

		{% endif %}
	</div> <!-- /list-updates -->

</div><!-- /content-body -->

<div class="content-footer">
	<div class="row">
		<div class="col-sm-7">
		</div>
		<div class="col-sm-5">
			{% include 'pagination.html' %}
		</div>

	</div>
</div>

{% endblock %}

{% block sidebar%}

	{# if content.meta.permissions.create #}
	<div class="metabar-module">
		<h5>Got something to add?</h5>
		<div class="metabar-module-primary-buttons">
			<a href="{% url 'updates-settings' %}" class="btn btn-large btn-block btn-primary">
				<span class="glyphicon glyphicon-comment"></span> Update Settings
			</a>
		</div>
	</div> <!-- primary actions -->
	{# endif #}


	<div class="metabar-module">
		<h5>About</h5>
		<div class="metabar-module-title">
			<h3>
				Updates
			</h3>
		</div>
	</div> <!-- / about -->


{% endblock%}
{% block js %}
<script type="text/javascript">

$('.inline-subscribe').each(function(index,item){
	console.log(item);
	var subscribe = new Subscribe({
		el    : item,
		url   : '{% url 'single-watcher' %}',
		id    : function(){ return this.button.attr('data-content-id'); },
		type  : function(){ return this.button.attr('data-content-type'); },
		token : '{{ csrf_token }}',
		is_subscribed : true
	});
});

</script>
{% endblock %}
