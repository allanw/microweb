<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>{{ site.title }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="shortcut icon" href="/static/img/favico.png" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">

    <link href="{{ STATIC_URL }}themes/{{ site.theme_id|default:"1" }}/css/bootstrap.min.css" rel="stylesheet" type="text/css" />

    <style type="text/css">
    .headBand {
      background-image: url('{% if site.header_background_url %}{{ site.header_background_url }}{% else %}{{ STATIC_URL }}themes/1/background.png{% endif %}');
    }
    </style>
    {% block css %}{% endblock %}
  </head>
  <body>

    <nav class="navbar navbar-default" role="navigation">
      <div class="navbar-header-wrapper tiling-bg">
        <div class="container">
          <div class="row">

            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header col-xs-12">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>

              <button type="button" class="navbar-toggle metabar-toggle">
                <span class="sr-only">Toggle metabar</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>

                <div class="row">
                  <div class="col-sm-3 col-md-3 col-lg-2 navbar-brand">
                    <a href="/" title="Return to Homepage">
                      <img src="{% if site.logo_url %}{{ site.logo_url }}{% else %}{{ STATIC_URL }}themes/1/logo.png{% endif %}" alt="{{ site.title }} - Powered by Microcosm" id="logo" />
                    </a>
                  </div>


                    <div class="col-sm-3 col-md-3 col-lg-2 navbar-profile navbar-collapse">
                    {% if user %}
                      <a href="{% url 'edit-profile' user.id %}" title="Edit your profile">
                        <img src="{% if 'gravatar' in user.avatar %}{{user.avatar}}{% elif 'files' in user.avatar %}https://{{site.subdomain_key}}.microco.sm{{user.avatar}}{% else %}/static/img/avatar.gif{% endif %}" alt="Avatar for {{ user.profile_name }}" title="Edit your profile" />
                        <strong>{{ user.profile_name }}</strong>
                      </a>
                      <a href="#">
                        <span class="glyphicon glyphicon-envelope"></span>
                        <strong>Huddles</strong>
                        <span class="badge">new</span>
                      </a>
                    {% else %}
                      <button class="btn btn-primary btn-block btn-lg" id="login_link" onclick="login()">
                        Sign In or Register
                      </button>
                    {% endif %}
                    </div><!-- /.navbar-profile -->
                  <div class="col-sm-5 col-md-6 col-lg-6 navbar-search navbar-collapse">
                    <form class="navbar-form navbar-left" role="search" action="{% url 'single-search' %}">
                      <div class="input-group">
                        <label class="input-group-addon" for="navbar-search-input">
                          <span class="glyphicon glyphicon-search"></span>
                        </label>
                        <input type="text"
                               id="navbar-search-input"
                               class="form-control"
                               name="q"
                               placeholder="Search conversations, events and people..."
                               {% if content.query.searched %}value="{{content.query.searched|safe}}"{% endif %} />
                      </div>
                    </form>
                  </div> <!-- /navbar-search -->

                <div class="clearfix"></div>
              </div>
            </div>

          </div>
        </div>
      </div> <!-- / navbar-header-wrapper -->
      <div class="navbar-nav-wrapper">
        <div class="container">
          <div class="row">
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse">
              <ul class="nav navbar-nav">
                <li class="active">
                  <a href="{% url 'index' %}">Microcosms</a>
                </li>
                <li>
                  <a href="#">Trending</a>
                </li>
                <li>
                  <a href="{% url 'list-updates' %}">
                    {% if user.unread_count %}
                    <span class="badge pull-right">{{ user.unread_count }}</span>
                    {% endif %}
                    Updates
                  </a>
                </li>
                <li>
                  <a href="{% url 'list-profiles' %}">People</a>
                </li>
                <li class="dropdown">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown">Custom <b class="caret"></b></a>
                  <ul class="dropdown-menu">
                    <li><a href="#">Action</a></li>
                    <li><a href="#">Another action</a></li>
                    <li><a href="#">Something else here</a></li>
                    <li class="divider"></li>
                    <li><a href="#">Separated link</a></li>
                    <li class="divider"></li>
                    <li><a href="#">One more separated link</a></li>
                  </ul>
                </li>
              </ul>

            </div><!-- /.navbar-collapse -->
          </div>
        </div>
      </div> <!-- / navbar-nav-wrapper -->

    </nav> <!-- /nav -->


    <div class="container main">
      <div class="row">
        <div class="col-md-9 content">
          {% block content %}{% endblock content %}
        </div> <!-- / content -->
        <div class="col-md-3 metabar">
          {% block sidebar %}{% endblock %}
          <div class="metabar-footer">
            Powered by <a href="#">Microcosm</a>
            <p>
              <a href="#">About</a>
              <a href="#">Help</a>
              <a href="#">Developers</a>
              <a href="#">Legal</a>
            </p>
          </div>
        </div> <!-- / metabar -->
      </div>
    </div>



    {% if not user %}
    <!-- Persona Login Form (submitted by persona login action, not directly by user) -->
    <form id="login-form" method="POST" action="{% url 'login' %}">
      {% csrf_token %}
      <input id="Assertion" type="hidden" name="Assertion" value="" />
      <input id="target_url" type="hidden" name="target_url" value="{{ request.get_full_path }}" />
    </form>

    <!-- Mozilla Persona -->
    <script src="{{ STATIC_URL }}js/persona.js"></script>
    <script>
      function login() {
        navigator.id.get(function(assertion) {
          if (assertion) {
            var assertion_field = document.getElementById("Assertion");
            assertion_field.value = assertion;
            var login_form = document.getElementById("login-form");
            login_form.submit();
          }
        });
      }
    </script>
  {% endif %}


    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.0.0/moment.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.js"></script>



    <script src="{{ STATIC_URL }}js/bootstrap.min.js"></script>
    <script src="{{ STATIC_URL }}js/base.js"></script>
    <script src="{{ STATIC_URL }}js/metabar.js"></script>

    {% block js %}{% endblock js%}

{% if item_type == "microcosm" or item_type == "profile" or item_type == "huddle" or item_type == "event" or item_type == "conversation" %}
  <script type="text/javascript">
  $( "#subscribe_form" ).on('submit', function( event ) {
    // Stop form from submitting normally
    event.preventDefault();

    var $form = $( this ),
    itemid = {{ content.id }},
    itemtype = "{{item_type}}",
    url = "{% url 'single-watcher' %}";
    // Send the data using post
    if (~(String($('#subscribe_button').attr('class'))).indexOf("success")) {
      data = { itemId: itemid, itemType: itemtype, csrfmiddlewaretoken: '{{ csrf_token }}' }
    } else {
      data = { itemId: itemid, itemType: itemtype, csrfmiddlewaretoken: '{{ csrf_token }}', delete: true }
    };
    var posting = $.ajax({
      type: "POST",
      url: url,
      beforeSend: function(xhr) {
        xhr.setRequestHeader("X-CSRFToken", getCookie("csrftoken"));
      },
      data: data
    });

    posting.error(function( data ) {
      $('#subscribe_button').attr('class', 'btn btn-xsmall btn-primary btn-danger');
      $('#subscribe_button').val('An error has occured');
    });
    posting.success(function(response){
      if (response.data){
        $('#emailme').prop('checked',true);
      } else {
        $('#emailme').prop('checked',false);
      }
    });
  });

  $("#emailme").on('click', function( event ) {
    $('#email_me_form').submit();
  });

  $('#email_me_form').on('submit', function( event ){
    event.preventDefault();

    var $form = $( this ),
    itemid = {{ content.id }},
    itemtype = "{{item_type}}",
    url = "{% url 'single-watcher' %}";
    // Send the data using patch
    data = { itemId: itemid, itemType: itemtype, emailMe: $("#emailme").is(':checked'), patch: true }
    var posting = $.ajax({
      type: "POST",
      url: url,
      beforeSend: function(xhr) {
        xhr.setRequestHeader("X-CSRFToken", getCookie("csrftoken"));
      },
      data: data
    });
    posting.error(function( data ) {
      $('#subscribe_button').attr('class', 'btn btn-xsmall btn-primary btn-danger');
    });
  });

if (typeof String.prototype.trimLeft !== "function") {
  String.prototype.trimLeft = function() {
      return this.replace(/^\s+/, "");
  };
}
if (typeof String.prototype.trimRight !== "function") {
    String.prototype.trimRight = function() {
        return this.replace(/\s+$/, "");
    };
}
if (typeof Array.prototype.map !== "function") {
    Array.prototype.map = function(callback, thisArg) {
        for (var i=0, n=this.length, a=[]; i<n; i++) {
            if (i in this) a[i] = callback.call(thisArg, this[i]);
        }
        return a;
    };
}
function getCookies() {
    var c = document.cookie, v = 0, cookies = {};
    if (document.cookie.match(/^\s*\$Version=(?:"1"|1);\s*(.*)/)) {
        c = RegExp.$1;
        v = 1;
    }
    if (v === 0) {
        c.split(/[,;]/).map(function(cookie) {
            var parts = cookie.split(/=/, 2),
                name = decodeURIComponent(parts[0].trimLeft()),
                value = parts.length > 1 ? decodeURIComponent(parts[1].trimRight()) : null;
            cookies[name] = value;
        });
    } else {
        c.match(/(?:^|\s+)([!#$%&'*+\-.0-9A-Z^`a-z|~]+)=([!#$%&'*+\-.0-9A-Z^`a-z|~]*|"(?:[\x20-\x7E\x80\xFF]|\\[\x00-\x7F])*")(?=\s*[,;]|$)/g).map(function($0, $1) {
            var name = $0,
                value = $1.charAt(0) === '"'
                          ? $1.substr(1, -1).replace(/\\(.)/g, "$1")
                          : $1;
            cookies[name] = value;
        });
    }
    return cookies;
}
function getCookie(name) {
    return getCookies()[name];
}

  </script>
{% endif %}
    <!-- Google Analytics -->
    <script type="text/javascript">
      {% if site.subdomain_key == 'dev1' or site.subdomain_key == 'dev2' %}window['ga-disable-UA-36931318-3'] = true;{% endif %}

      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      var gaData = {
        'dimension1': '{% if user %}contributor{% else %}lurker{% endif %}'
        ,'dimension4': '{{ site.subdomain_key }}'
        {% block ga %}{% endblock %}
      };

      ga('create', 'UA-36931318-3', 'microco.sm');
      ga('send', 'pageview', gaData);

      {% if site.ga_web_property_id %}ga('create', '{{ site.ga_web_property_id }}', {'name': '{{ site.subdomain_key }}'});
      ga('{{ site.subdomain_key }}.send', 'pageview', gaData);{% endif %}
    </script>

  </body>
<html>
